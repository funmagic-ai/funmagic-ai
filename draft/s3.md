 Master Specification: funmagic.ai Asset Management & Traffic Architecture

## 1. Infrastructure & Global Distribution

The system uses a triple-domain strategy to balance high-performance public delivery with strictly authorized private access.

* **Regional Layout:**
* **Core Resources:** (EC2/ECS, S3, RDS, Redis) are located in `us-east-2` (Ohio).
* **SSL Certificates (ACM):** Must be requested in `us-east-1` (N. Virginia) as required by AWS CloudFront.


* **DNS (Cloudflare):** Cloudflare manages the DNS for `funmagic.ai`.
* **Crucial:** All CDN subdomains (`cdn` and `private-cdn`) must be set to **"DNS Only" (Grey Cloud)**. Disabling Cloudflare Proxy prevents double-caching conflicts and ensures ALB listener rules function correctly.


* **Domain Strategy:**
* `cdn.funmagic.ai`: Public assets (Ops materials, user-shared works).
* `private-cdn.funmagic.ai`: Private assets (User uploads, AI drafts). Requires RSA-signed URLs.



---

## 2. Storage & Multi-tenant Logic

Assets are stored in AWS S3 with **Physical Path Isolation** and **Logical Access Control**.

* **Physical Path Partitioning (Prefixes):**
* **Ops Assets:** `public/ops/{module}/...`
* **User Private:** `private/{user_id}/{module}/...` (Default for uploads/AI output).
* **User Public:** `public/shared/{user_id}/{post_id}/...` (Moved here upon sharing).
* **Admin Private:** `internal/admin/{audit_type}/...` (Stored in a separate high-security bucket).


* **S3 Security (OAC):**
* **Block Public Access:** Enabled for all buckets.
* **Bucket Policy:** Restricted to the CloudFront Service Principal via **Origin Access Control (OAC)**. The policy must use `AWS:SourceArn` to whitelist only your specific CloudFront Distributions.



---

## 3. Unified Asset Management Service

The core philosophy is the **Decoupling of Physical Storage (S3) from Logical Permission (Database)**.

### **A. Core Database Model (`assets` table)**

A single table tracks all files across all modules:

* `storage_key`: The relative S3 path (e.g., `private/u123/ai-gen/001.webp`).
* **`visibility`**: The master permission switch (`private`, `public`, `admin-private`).
* `user_id`: Ownership verification.
* `module`: Originating module (e.g., `ai_painter`, `avatar_upload`).

### **B. Core Business Logic**

1. **Secure Upload:** The backend generates S3 Presigned URLs by **injecting** the `user_id` and `module` into the path. The frontend cannot define the storage path, preventing unauthorized overwrites.
2. **URL Resolution (The Router):**
* **Decoupling:** Modules do not construct URLs. They call `AssetService.resolveUrl(asset)`.
* **Logic:** If `visibility` is `public`, it returns a standard `cdn.funmagic.ai` link. If `private`, it verifies ownership and generates a **CloudFront Signed URL** (15-min expiry). If `admin-private`, it generates an **S3 Direct Presigned URL** (bypassing CDN for max security).


3. **The Publishing Flow (State Transition):**
* When a user clicks "Share": The system performs an **S3 Copy + Delete** to move the file from `private/` to `public/shared/`. Simultaneously, it updates the `visibility` to `public` in the DB.
* **Why Visibility?** It acts as the "Instant Switch." Even if the physical move takes time, the logic immediately treats the asset as public, changing the URL generation behavior.



---

## 4. Traffic Steering & A/B Testing

Using **ALB (Application Load Balancer)** listener rules for granular traffic control during the EC2-to-ECS migration.

* **Feature Injection:**
* **Cookies:** `x-beta-access=true` for beta testers.
* **Headers:** `X-Dev-Mode: true` for internal developers.


* **CloudFront Pass-through:** CloudFront must use an **Origin Request Policy** to whitelist these Cookies/Headers, allowing them to reach the ALB.
* **ALB Listener Rules:**
* **Priority 1:** Match `Header: X-Dev-Mode=true`  Forward to **ECS Target Group**.
* **Priority 2:** Match `Cookie: x-beta-access=true`  Forward to **ECS Target Group**.
* **Default:** All other traffic  Forward to **EC2 Target Group (Stable)**.



---

## 5. Evolutionary Roadmap (Terraform & Docker)

The architecture is designed to grow from a lean startup setup to a high-scale elastic system.

* **Modular Terraform:** Network (VPC), Data (RDS, Redis, S3), and Compute (EC2, ECS) are managed as separate modules.
* **Stateless Application:** No files are stored on EC2/ECS disks. All state resides in Redis, and all files in S3.
* **The ECS Switch:** All apps are **Dockerized** from Day 1. Moving from EC2 to ECS Fargate involves adding a new compute module in Terraform without touching the underlying database or network.

---

### **Summary of the Lifecycle**

1. **Generation:** User creates an image. Itâ€™s saved to S3 `private/` and tagged `visibility: private` in the DB.
2. **Preview:** User views their gallery. `AssetService` generates a temporary **signed link** via `private-cdn.funmagic.ai`.
3. **Sharing:** User shares the image. System moves the file to `public/` and updates the DB to `visibility: public`.
4. **Global Access:** The image is now served via `cdn.funmagic.ai` with high cacheability and no signature required.
5. **Iteration:** Developers test a new UI on the same data by using a `Dev-Mode` header, which the ALB uses to route them to the **ECS staging cluster**.
 